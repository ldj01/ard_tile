# ard-tile

The Analysis-Ready Data (ARD) tiling project generates image tiles based on
Landsat scenes processed to Level 2 (surface reflectance and temperature).

## Installation

The system contains three components:

 - tile generation framework (Mesos framework)  
 - tile generator  
 - controller

The tiling framework and tile generator are installed into Docker
containers to be run in a Mesos cluster, whereas the controller
is installed onto a workstation or server with access to the Mesos cluster.
All three components interact with shared database tables to store and
retrieve information regarding the scenes being processed.

### Controller installation

The controller installation takes place on the designated workstation
or server, and is conducted as follows:

> `mkdir build` (if not already existing)   
  `cd build`  
  `cmake .. -CMAKE_INSTALL_PREFIX:PATH=/usr/local/usgs/ard_tile`  
  `make`  
  `sudo make install`

### Tile generation framework and application Docker images

Verify the version.txt files, and update if necessary:
> `external/version.txt`  
  `ARD_determine_segments_framework/version.txt`  
  `ARD_clip/version.txt`

Create and deploy the Docker images:

> `mkdir build` (if not already existing)  
  `cd build`  
  `cmake ..`  
  `make deploy`

If you want to test the containers before deployment, run the following
in lieu of "`make deploy`":

> `make ard-clip`  
  `make ard-segment`

## Database interaction

The framework interacts with the ARD\_PROCESSED\_SCENES and
ARD\_UNPROCESSED\_SCENES\_V tables.  The latter is polled for scenes
that are ready to add to tiles.  Scenes in the former have their processing
states updated when queued and have the state reset (to "BLANK") for running
or queued scenes when the framework is restarted.  New records are inserted
into ARD\_PROCESSED\_SCENES to identify duplicates and completed scenes.

The tile generator updates the scene processing state in ARD\_PROCESSED\_SCENES,
and inserts records into the ARD\_COMPLETED\_TILES table when tiles are
generated.  Scenes in adjacent rows for a given acquisition date are found
in the INVENTORY.LMD\_SCENE table, and scene corner coordinates are read
from the SCENE\_COORDINATE\_MASTER\_V table.  Input scene locations are
retrieved from the ARD\_L2\_ALBERS\_INVENTORY\_V table.

The controller polls the ARD\_PROCESSED\_SCENES table for the number of scenes
in the various states of processing (complete, inqueue, inwork, blank, and can
also list the product IDs for scenes in these states.  It also counts the number
of scenes in ARD\_UNPROCESSED\_SCENES\_V that are remaining.
If the operator requests a count of the scenes in an error state,
ARD\_PROCESSED\_SCENES is polled for the count of records in "ERROR" or "NOGRID"
state.

The controller reports the number of tiles successfully generated by polling
the ARD\_COMPLETED\_TILES table.